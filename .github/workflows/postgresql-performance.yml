name: PostgreSQL æ€§èƒ½åŸºå‡†æµ‹è¯•

on:
  workflow_dispatch:
    inputs:
      test_scale:
        description: 'æµ‹è¯•æ•°æ®è§„æ¨¡'
        required: true
        default: 'medium'
        type: choice
        options:
          - small    # 1Kè´¦æˆ·, 5Kæ–‡ç« 
          - medium   # 10Kè´¦æˆ·, 50Kæ–‡ç« 
          - large    # 50Kè´¦æˆ·, 200Kæ–‡ç« 
      test_type:
        description: 'æµ‹è¯•ç±»å‹'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - crud
          - join
          - pagination
          - count-optimization
  schedule:
    # æ¯å‘¨æ—¥å‡Œæ™¨2ç‚¹è¿è¡Œæ€§èƒ½åŸºå‡†æµ‹è¯•
    - cron: '0 2 * * 0'

jobs:
  postgresql-performance:
    name: PostgreSQL æ€§èƒ½åŸºå‡†æµ‹è¯•
    runs-on: ubuntu-latest
    timeout-minutes: 60
    
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: mybatis_flex_perf_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
          --shared-buffers=256MB
          --max_connections=100
          --work_mem=4MB

    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: è®¾ç½® JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: maven

    - name: ç­‰å¾… PostgreSQL å¯åŠ¨
      run: |
        sudo apt-get update && sudo apt-get install -y postgresql-client
        timeout 60s bash -c 'until pg_isready -h localhost -p 5432 -U postgres; do sleep 2; done'
        echo "âœ… PostgreSQL å·²å‡†å¤‡å°±ç»ª"

    - name: åˆå§‹åŒ–æ€§èƒ½æµ‹è¯•æ•°æ®åº“
      run: |
        echo "ğŸš€ åˆå§‹åŒ–æ€§èƒ½æµ‹è¯•æ•°æ®åº“..."
        
        # åˆ›å»ºåŸºç¡€è¡¨ç»“æ„
        PGPASSWORD=postgres psql -h localhost -U postgres -d mybatis_flex_perf_test \
          -f mybatis-flex-test/mybatis-flex-postgresql-test/src/main/resources/schema-postgresql.sql
        
        # æ ¹æ®æµ‹è¯•è§„æ¨¡ç”Ÿæˆä¸åŒæ•°é‡çš„æµ‹è¯•æ•°æ®
        case "${{ github.event.inputs.test_scale || 'medium' }}" in
          "small")
            ACCOUNT_COUNT=1000
            ARTICLE_MULTIPLIER=5
            ;;
          "medium")
            ACCOUNT_COUNT=10000
            ARTICLE_MULTIPLIER=5
            ;;
          "large")
            ACCOUNT_COUNT=50000
            ARTICLE_MULTIPLIER=4
            ;;
        esac
        
        echo "ğŸ“Š ç”Ÿæˆæµ‹è¯•æ•°æ®: ${ACCOUNT_COUNT} ä¸ªè´¦æˆ·, çº¦ $((ACCOUNT_COUNT * ARTICLE_MULTIPLIER)) ç¯‡æ–‡ç« "
        
        # ç”Ÿæˆå¤§é‡è´¦æˆ·æ•°æ®
        PGPASSWORD=postgres psql -h localhost -U postgres -d mybatis_flex_perf_test -c "
          INSERT INTO tb_account (user_name, age, sex, birthday, options, is_normal, is_delete)
          SELECT 
            'æ€§èƒ½æµ‹è¯•ç”¨æˆ·' || generate_series,
            (random() * 60 + 18)::int,
            (random() + 1)::int,
            CURRENT_DATE - (random() * 365 * 30)::int,
            CASE 
              WHEN random() > 0.8 THEN '{\"premium\": true, \"level\":' || (random() * 10)::int || '}'
              ELSE '{\"premium\": false, \"level\":' || (random() * 5)::int || '}'
            END,
            CASE WHEN random() > 0.1 THEN 1 ELSE 0 END,
            CASE WHEN random() > 0.95 THEN 1 ELSE 0 END
          FROM generate_series(1, ${ACCOUNT_COUNT});
        "
        
        # ç”Ÿæˆå¤§é‡æ–‡ç« æ•°æ®
        PGPASSWORD=postgres psql -h localhost -U postgres -d mybatis_flex_perf_test -c "
          INSERT INTO tb_article (account_id, title, content, is_delete)
          SELECT 
            (random() * ${ACCOUNT_COUNT} + 1)::int,
            'æ€§èƒ½æµ‹è¯•æ–‡ç« æ ‡é¢˜' || generate_series || ' - ' || 
            CASE (random() * 5)::int
              WHEN 0 THEN 'Javaå¼€å‘'
              WHEN 1 THEN 'Spring Boot'
              WHEN 2 THEN 'MyBatis-Flex'
              WHEN 3 THEN 'PostgreSQL'
              ELSE 'æ•°æ®åº“ä¼˜åŒ–'
            END,
            'è¿™æ˜¯ç¬¬' || generate_series || 'ç¯‡æ€§èƒ½æµ‹è¯•æ–‡ç« çš„è¯¦ç»†å†…å®¹ï¼ŒåŒ…å«äº†å¤§é‡çš„æ–‡æœ¬æ•°æ®ç”¨äºæµ‹è¯•æŸ¥è¯¢æ€§èƒ½ã€‚' ||
            repeat('å†…å®¹å¡«å……æ–‡æœ¬ï¼Œæ¨¡æ‹ŸçœŸå®æ–‡ç« é•¿åº¦ã€‚', (random() * 20 + 5)::int),
            CASE WHEN random() > 0.9 THEN 1 ELSE 0 END
          FROM generate_series(1, ${ACCOUNT_COUNT} * ${ARTICLE_MULTIPLIER});
        "
        
        # åˆ›å»ºæ€§èƒ½ä¼˜åŒ–ç´¢å¼•
        PGPASSWORD=postgres psql -h localhost -U postgres -d mybatis_flex_perf_test -c "
          CREATE INDEX CONCURRENTLY idx_account_age_sex ON tb_account(age, sex) WHERE is_delete = 0;
          CREATE INDEX CONCURRENTLY idx_account_user_name ON tb_account(user_name) WHERE is_delete = 0;
          CREATE INDEX CONCURRENTLY idx_article_account_id ON tb_article(account_id) WHERE is_delete = 0;
          CREATE INDEX CONCURRENTLY idx_article_title ON tb_article USING gin(to_tsvector('english', title));
          CREATE INDEX CONCURRENTLY idx_article_created_at ON tb_article(created_at) WHERE is_delete = 0;
        "
        
        # æ›´æ–°è¡¨ç»Ÿè®¡ä¿¡æ¯
        PGPASSWORD=postgres psql -h localhost -U postgres -d mybatis_flex_perf_test -c "ANALYZE tb_account; ANALYZE tb_article;"
        
        # æ˜¾ç¤ºæ•°æ®ç»Ÿè®¡
        echo "ğŸ“ˆ æ•°æ®åº“ç»Ÿè®¡ä¿¡æ¯:"
        PGPASSWORD=postgres psql -h localhost -U postgres -d mybatis_flex_perf_test -c "
          SELECT 
            'tb_account' as table_name,
            COUNT(*) as total_rows,
            COUNT(*) FILTER (WHERE is_delete = 0) as active_rows
          FROM tb_account
          UNION ALL
          SELECT 
            'tb_article' as table_name,
            COUNT(*) as total_rows,
            COUNT(*) FILTER (WHERE is_delete = 0) as active_rows
          FROM tb_article;
        "

    - name: ç¼–è¯‘æ€§èƒ½æµ‹è¯•æ¨¡å—
      run: |
        echo "ğŸ”¨ ç¼–è¯‘æ€§èƒ½æµ‹è¯•æ¨¡å—..."
        mvn compile test-compile -pl mybatis-flex-test/mybatis-flex-postgresql-test -B -q

    - name: è¿è¡ŒåŸºç¡€ CRUD æ€§èƒ½æµ‹è¯•
      if: github.event.inputs.test_type == 'all' || github.event.inputs.test_type == 'crud'
      run: |
        echo "ğŸ§ª è¿è¡ŒåŸºç¡€ CRUD æ€§èƒ½æµ‹è¯•..."
        mvn test -pl mybatis-flex-test/mybatis-flex-postgresql-test \
          -Dtest="PostgreSQLBasicCrudTest" -B -Pci \
          -Dmaven.test.failure.ignore=false
      env:
        CI: true
        SPRING_DATASOURCE_URL: jdbc:postgresql://localhost:5432/mybatis_flex_perf_test
        SPRING_DATASOURCE_USERNAME: postgres
        SPRING_DATASOURCE_PASSWORD: postgres
        PERFORMANCE_TEST: true

    - name: è¿è¡Œ JOIN æŸ¥è¯¢æ€§èƒ½æµ‹è¯•
      if: github.event.inputs.test_type == 'all' || github.event.inputs.test_type == 'join'
      run: |
        echo "ğŸ”— è¿è¡Œ JOIN æŸ¥è¯¢æ€§èƒ½æµ‹è¯•..."
        mvn test -pl mybatis-flex-test/mybatis-flex-postgresql-test \
          -Dtest="PostgreSQLJoinTest" -B -Pci \
          -Dmaven.test.failure.ignore=false
      env:
        CI: true
        SPRING_DATASOURCE_URL: jdbc:postgresql://localhost:5432/mybatis_flex_perf_test
        SPRING_DATASOURCE_USERNAME: postgres
        SPRING_DATASOURCE_PASSWORD: postgres
        PERFORMANCE_TEST: true

    - name: è¿è¡Œåˆ†é¡µæ€§èƒ½åŸºå‡†æµ‹è¯•
      if: github.event.inputs.test_type == 'all' || github.event.inputs.test_type == 'pagination'
      run: |
        echo "ğŸ“„ è¿è¡Œåˆ†é¡µæ€§èƒ½åŸºå‡†æµ‹è¯•..."
        mvn test -pl mybatis-flex-test/mybatis-flex-postgresql-test \
          -Dtest="PostgreSQLJoinTest#testLargeDataJoinPagination" -B -Pci \
          -Dmaven.test.failure.ignore=false
      env:
        CI: true
        SPRING_DATASOURCE_URL: jdbc:postgresql://localhost:5432/mybatis_flex_perf_test
        SPRING_DATASOURCE_USERNAME: postgres
        SPRING_DATASOURCE_PASSWORD: postgres
        PERFORMANCE_TEST: true

    - name: è¿è¡Œ COUNT æŸ¥è¯¢ä¼˜åŒ–åŸºå‡†æµ‹è¯•
      if: github.event.inputs.test_type == 'all' || github.event.inputs.test_type == 'count-optimization'
      run: |
        echo "ğŸ“Š è¿è¡Œ COUNT æŸ¥è¯¢ä¼˜åŒ–åŸºå‡†æµ‹è¯•..."
        mvn test -pl mybatis-flex-test/mybatis-flex-postgresql-test \
          -Dtest="*#testOptimizeCountQuery" -B -Pci \
          -Dmaven.test.failure.ignore=false
      env:
        CI: true
        SPRING_DATASOURCE_URL: jdbc:postgresql://localhost:5432/mybatis_flex_perf_test
        SPRING_DATASOURCE_USERNAME: postgres
        SPRING_DATASOURCE_PASSWORD: postgres
        PERFORMANCE_TEST: true

    - name: ç”Ÿæˆæ€§èƒ½åŸºå‡†æŠ¥å‘Š
      if: always()
      run: |
        echo "ğŸ“Š === PostgreSQL æ€§èƒ½åŸºå‡†æµ‹è¯•æŠ¥å‘Š ===" 
        echo "æµ‹è¯•è§„æ¨¡: ${{ github.event.inputs.test_scale || 'medium' }}"
        echo "æµ‹è¯•ç±»å‹: ${{ github.event.inputs.test_type || 'all' }}"
        echo "æ‰§è¡Œæ—¶é—´: $(date)"
        echo "PostgreSQL ç‰ˆæœ¬: 15"
        echo ""
        
        # æ˜¾ç¤ºæ•°æ®åº“æ€§èƒ½ç»Ÿè®¡
        echo "ğŸ¯ æ•°æ®åº“æ€§èƒ½ç»Ÿè®¡:"
        PGPASSWORD=postgres psql -h localhost -U postgres -d mybatis_flex_perf_test -c "
          SELECT 
            schemaname,
            tablename,
            seq_scan,
            seq_tup_read,
            idx_scan,
            idx_tup_fetch,
            n_tup_ins,
            n_tup_upd,
            n_tup_del
          FROM pg_stat_user_tables 
          WHERE schemaname = 'public';
        "
        
        echo ""
        echo "ğŸ” ç´¢å¼•ä½¿ç”¨ç»Ÿè®¡:"
        PGPASSWORD=postgres psql -h localhost -U postgres -d mybatis_flex_perf_test -c "
          SELECT 
            schemaname,
            tablename,
            indexname,
            idx_scan,
            idx_tup_read,
            idx_tup_fetch
          FROM pg_stat_user_indexes 
          WHERE schemaname = 'public'
          ORDER BY idx_scan DESC;
        "
        
        # è§£ææµ‹è¯•æŠ¥å‘Š
        if [ -d mybatis-flex-test/mybatis-flex-postgresql-test/target/surefire-reports/ ]; then
          echo ""
          echo "ğŸ§ª æµ‹è¯•æ‰§è¡Œç»“æœ:"
          cd mybatis-flex-test/mybatis-flex-postgresql-test/target/surefire-reports/
          
          total_tests=0
          total_time=0
          
          for file in *.xml; do
            if [ -f "$file" ]; then
              tests=$(grep -o 'tests="[0-9]*"' "$file" | cut -d'"' -f2)
              time=$(grep -o 'time="[0-9.]*"' "$file" | cut -d'"' -f2)
              class_name=$(basename "$file" .xml | sed 's/TEST-//')
              
              echo "  ğŸ“‹ $class_name: $tests ä¸ªæµ‹è¯•, è€—æ—¶ ${time}s"
              
              total_tests=$((total_tests + tests))
              total_time=$(echo "$total_time + $time" | bc -l)
            fi
          done
          
          echo ""
          echo "ğŸ“ˆ æ€§èƒ½åŸºå‡†æ€»ç»“:"
          echo "  - æ€»æµ‹è¯•æ•°: $total_tests"
          echo "  - æ€»è€—æ—¶: ${total_time}s"
          echo "  - å¹³å‡æ¯æµ‹è¯•è€—æ—¶: $(echo "scale=3; $total_time / $total_tests" | bc)s"
          
          # æ€§èƒ½åŸºå‡†åˆ¤æ–­
          if (( $(echo "$total_time < 30" | bc -l) )); then
            echo "  âœ… æ€§èƒ½è¡¨ç°: ä¼˜ç§€ (< 30s)"
          elif (( $(echo "$total_time < 60" | bc -l) )); then
            echo "  âœ… æ€§èƒ½è¡¨ç°: è‰¯å¥½ (30s-60s)"
          elif (( $(echo "$total_time < 120" | bc -l) )); then
            echo "  âš ï¸  æ€§èƒ½è¡¨ç°: ä¸€èˆ¬ (60s-120s)"
          else
            echo "  âŒ æ€§èƒ½è¡¨ç°: éœ€è¦ä¼˜åŒ– (> 120s)"
          fi
        else
          echo "âŒ æœªæ‰¾åˆ°æµ‹è¯•æŠ¥å‘Š"
        fi

    - name: ä¸Šä¼ æ€§èƒ½æµ‹è¯•æŠ¥å‘Š
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: postgresql-performance-${{ github.event.inputs.test_scale || 'medium' }}-${{ github.event.inputs.test_type || 'all' }}-report
        path: |
          mybatis-flex-test/mybatis-flex-postgresql-test/target/surefire-reports/
          mybatis-flex-test/mybatis-flex-postgresql-test/target/site/
        retention-days: 30

    - name: æ€§èƒ½å›å½’æ£€æŸ¥
      if: github.event.inputs.test_type == 'all'
      run: |
        echo "ğŸ” æ€§èƒ½å›å½’æ£€æŸ¥..."
        
        # è¿™é‡Œå¯ä»¥æ·»åŠ ä¸å†å²æ€§èƒ½æ•°æ®çš„å¯¹æ¯”é€»è¾‘
        # ä¾‹å¦‚ï¼šä¸ä¸Šæ¬¡çš„æ€§èƒ½åŸºå‡†è¿›è¡Œå¯¹æ¯”ï¼Œå¦‚æœæ€§èƒ½ä¸‹é™è¶…è¿‡20%åˆ™è­¦å‘Š
        
        echo "ğŸ’¡ å»ºè®®ï¼š"
        echo "  - å®šæœŸè¿è¡Œæ€§èƒ½åŸºå‡†æµ‹è¯•"
        echo "  - å…³æ³¨æ…¢æŸ¥è¯¢å’Œç´¢å¼•ä½¿ç”¨æƒ…å†µ"
        echo "  - ç›‘æ§æ•°æ®åº“è¿æ¥æ± å’Œå†…å­˜ä½¿ç”¨"
        echo "  - è€ƒè™‘åœ¨æ›´å¤§è§„æ¨¡æ•°æ®ä¸Šè¿›è¡Œå‹åŠ›æµ‹è¯•"